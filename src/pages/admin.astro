---
import Layout from "../layouts/Layout.astro";
import { getSessionFromCookie, isValidSession } from "../lib/auth";
import {
  getSealsCount,
  getLastUpdate,
  getScrapeLogs,
  getAllCategories,
} from "../lib/neon.js";

export const prerender = false;

// Verificar autenticaci√≥n
const cookieHeader = Astro.request.headers.get("cookie") || "";
const token = getSessionFromCookie(cookieHeader);

// Redirigir si no est√° autenticado
if (!isValidSession(token)) {
  return Astro.redirect("/login");
}

// Obtener datos para el dashboard
let sealsCount = 0;
let lastUpdate = null;
let scrapeLogs: any[] = [];
let categoriesCount = 0;

try {
  sealsCount = Number(await getSealsCount());
  lastUpdate = await getLastUpdate();
  scrapeLogs = (await getScrapeLogs(10)) as any[];
  const categories = await getAllCategories();
  categoriesCount = categories.length;
} catch (error) {
  console.error("Error loading admin data:", error);
}
---

<Layout title="Admin - DMO Seals">
  <div
    class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <!-- Header -->
    <header
      class="border-b border-slate-700/50 bg-slate-900/50 backdrop-blur-sm">
      <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
              ‚öôÔ∏è Panel de Administraci√≥n
            </h1>
            <p class="text-sm text-slate-400">DMO Seal Master</p>
          </div>

          <div class="flex items-center gap-3">
            <a
              href="/"
              class="flex items-center gap-2 px-4 py-2 rounded-lg bg-slate-800/50 border border-slate-700/50 hover:border-blue-500 hover:bg-slate-800 text-sm text-slate-300 hover:text-white transition-all">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              Men√∫ Principal
            </a>
            <button
              id="logout-btn"
              class="px-4 py-2 text-sm bg-red-500/20 text-red-400 hover:bg-red-500/30 rounded-lg border border-red-500/30 hover:border-red-500/50 transition-all">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700/50">
          <div class="text-3xl font-bold text-white">{sealsCount}</div>
          <div class="text-sm text-slate-400">Total Seals</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700/50">
          <div class="text-3xl font-bold text-white">{categoriesCount}</div>
          <div class="text-sm text-slate-400">Categor√≠as</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700/50">
          <div class="text-xl font-bold text-white">
            {
              lastUpdate
                ? new Date(lastUpdate as string).toLocaleDateString("es-AR")
                : "Nunca"
            }
          </div>
          <div class="text-sm text-slate-400">√öltima actualizaci√≥n</div>
        </div>
        <div class="bg-slate-800 rounded-xl p-6 border border-slate-700/50">
          <div class="text-3xl font-bold text-white">{scrapeLogs.length}</div>
          <div class="text-sm text-slate-400">Scrapes realizados</div>
        </div>
      </div>

      <!-- Management Section -->
      <div class="bg-slate-800 rounded-xl border border-slate-700/50 mb-8">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-lg font-semibold text-white">üõ†Ô∏è Gesti√≥n de Datos</h2>
          <p class="text-sm text-slate-400 mt-1">
            Administrar seals y sus locaciones
          </p>
        </div>
        <div class="p-6">
          <a
            href="/admin/locations"
            class="inline-flex items-center gap-2 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-colors"
          >
            üìç Gestionar Locaciones
          </a>
        </div>
      </div>

      <!-- Scraping Section -->
      <div class="bg-slate-800 rounded-xl border border-slate-700/50 mb-8">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-lg font-semibold text-white">üîÑ Actualizar Datos</h2>
          <p class="text-sm text-slate-400 mt-1">
            Ejecutar scraping desde DMO Wiki para obtener los √∫ltimos datos
          </p>
        </div>
        <div class="p-6">
          <button
            id="scrape-btn"
            class="px-6 py-3 bg-dmo-primary hover:bg-dmo-primary/90 text-white font-medium rounded-lg transition-all focus:outline-none focus:ring-2 focus:ring-dmo-primary focus:ring-offset-2 focus:ring-offset-slate-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <span id="scrape-icon">üöÄ</span>
            <span id="scrape-text">Ejecutar Scraping</span>
          </button>

          <div id="scrape-result" class="mt-4 hidden">
            <div class="p-4 rounded-lg" id="result-box">
              <span id="result-message"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scraping History -->
      <div class="bg-slate-800 rounded-xl border border-slate-700/50">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-lg font-semibold text-white">
            üìã Historial de Scraping
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-slate-700/50">
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
                  Fecha
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
                  Estado
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
                  Seals
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">
                  Duraci√≥n
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-700/50">
              {
                scrapeLogs.length === 0 ? (
                  <tr>
                    <td
                      colspan="4"
                      class="px-6 py-8 text-center text-slate-400">
                      No hay registros de scraping
                    </td>
                  </tr>
                ) : (
                  scrapeLogs.map((log: any) => {
                    const startedAt = new Date(log.started_at);
                    const finishedAt = log.finished_at
                      ? new Date(log.finished_at)
                      : null;
                    const duration = finishedAt
                      ? Math.round(
                          (finishedAt.getTime() - startedAt.getTime()) / 1000
                        )
                      : null;

                    return (
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                          {startedAt.toLocaleString("es-AR")}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span
                            class={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                              log.status === "success"
                                ? "bg-emerald-500/20 text-emerald-400"
                                : log.status === "running"
                                  ? "bg-yellow-500/20 text-yellow-400"
                                  : "bg-red-500/20 text-red-400"
                            }`}>
                            {log.status === "success"
                              ? "‚úì Exitoso"
                              : log.status === "running"
                                ? "‚è≥ En progreso"
                                : "‚úó Fallido"}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
                          {log.seals_count || "-"}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                          {duration !== null ? `${duration}s` : "-"}
                        </td>
                      </tr>
                    );
                  })
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script is:inline>
  (function() {
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async function() {
        try {
          await fetch("/api/auth/logout", { method: "POST" });
          window.location.href = "/login";
        } catch (e) {
          // Error handling
        }
      });
    }

    const scrapeBtnEl = document.getElementById("scrape-btn");
    if (!scrapeBtnEl) return;

    const scrapeIconEl = document.getElementById("scrape-icon");
    const scrapeTextEl = document.getElementById("scrape-text");
    const scrapeResultEl = document.getElementById("scrape-result");
    const resultBoxEl = document.getElementById("result-box");
    const resultMessageEl = document.getElementById("result-message");

    scrapeBtnEl.addEventListener("click", async function() {
      scrapeBtnEl.setAttribute("disabled", "");
      if (scrapeIconEl) scrapeIconEl.textContent = "‚è≥";
      if (scrapeTextEl) scrapeTextEl.textContent = "Ejecutando...";
      if (scrapeResultEl) scrapeResultEl.classList.add("hidden");

      try {
        const response = await fetch("/api/admin/scrape", {
          method: "POST"
        });

        const data = await response.json();

        if (scrapeResultEl) scrapeResultEl.classList.remove("hidden");

        if (response.ok) {
          if (resultBoxEl) {
            resultBoxEl.className = "p-4 rounded-lg bg-emerald-500/20 border border-emerald-500/50";
          }
          if (resultMessageEl) {
            resultMessageEl.textContent = "‚úì " + data.message + " - " + data.sealsCount + " seals actualizados";
          }

          setTimeout(function() {
            window.location.reload();
          }, 2000);
        } else {
          if (resultBoxEl) {
            resultBoxEl.className = "p-4 rounded-lg bg-red-500/20 border border-red-500/50";
          }
          if (resultMessageEl) {
            resultMessageEl.textContent = "‚úó " + data.error + (data.details ? ": " + data.details : "");
          }
        }
      } catch (e) {
        if (scrapeResultEl) scrapeResultEl.classList.remove("hidden");
        if (resultBoxEl) {
          resultBoxEl.className = "p-4 rounded-lg bg-red-500/20 border border-red-500/50";
        }
        if (resultMessageEl) {
          resultMessageEl.textContent = "‚úó Error de conexi√≥n";
        }
      } finally {
        scrapeBtnEl.removeAttribute("disabled");
        if (scrapeIconEl) scrapeIconEl.textContent = "üöÄ";
        if (scrapeTextEl) scrapeTextEl.textContent = "Ejecutar Scraping";
      }
    });
  })();
</script>
